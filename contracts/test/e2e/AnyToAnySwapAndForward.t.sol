// SPDX-License-Identifier: Unlicense
pragma solidity ^0.8.19;

import {TransferHelper} from "@uniswap/v3-periphery/contracts/libraries/TransferHelper.sol";
import {IERC20} from "@openzeppelin/contracts/token/ERC20/IERC20.sol";

import {SwapAndXCall} from "../../origin/Swap/SwapAndXCall.sol";
import {TestHelper} from "../utils/TestHelper.sol";
import {Greeter} from "../utils/Greeter.sol";
import {XSwapAndGreetTarget} from "../../example/XSwapAndGreet/XSwapAndGreetTarget.sol";
import {OneInchUniswapV3} from "../../shared/Swap/OneInch/OneInchUniswapV3.sol";

contract AnyToAnySwapAndForwardTest is TestHelper {
  SwapAndXCall swapAndXCall;
  Greeter greeter;
  XSwapAndGreetTarget xSwapAndGreetTarget;
  OneInchUniswapV3 oneInchUniswapV3;

  address public immutable OP_OP = 0x4200000000000000000000000000000000000042;
  address public immutable OP_USDC = 0x7F5c764cBc14f9669B88837ca1490cCa17c31607;
  address public immutable ARB_ARB = 0x912CE59144191C1204E64559FE8253a0e49E6548;

  address public immutable OP_OP_WHALE = 0x2501c477D0A35545a387Aa4A3EEe4292A9a8B3F0;
  address public immutable ONEINCH_SWAPPER = 0x1111111254EEB25477B68fb85Ed929f73A960582;

  function utils_setUpOrigin() public {
    setUpOptimism(87307161);
    swapAndXCall = new SwapAndXCall(CONNEXT_OPTIMISM);
    vm.prank(OP_OP_WHALE);
    TransferHelper.safeTransfer(OP_OP, address(this), 1000 ether);

    vm.label(address(swapAndXCall), "SwapAndXCall");
    vm.label(address(this), "AnyToAnySwapAndForwardTest");
    vm.label(OP_OP, "OP_OP");
    vm.label(OP_USDC, "OP_USDC");
    vm.label(OP_OP_WHALE, "OP_OP_WHALE");
  }

  function utils_setUpDestination() public {
    setUpArbitrum(78000226);
    greeter = new Greeter();
    xSwapAndGreetTarget = new XSwapAndGreetTarget(address(greeter), MOCK_CONNEXT);
    oneInchUniswapV3 = new OneInchUniswapV3(ONEINCH_SWAPPER);
    xSwapAndGreetTarget.addSwapper(address(oneInchUniswapV3)); // 1inch address on arbitrum

    vm.label(address(greeter), "Greeter");
    vm.label(address(xSwapAndGreetTarget), "XSwapAndGreetTarget");
    vm.label(address(oneInchUniswapV3), "OneInchUniswapV3");
    vm.label(ARB_ARB, "ARB_ARB");
  }

  function test_AnyToAnySwapAndForwardTest__works() public {
    utils_setUpOrigin();
    utils_setUpDestination();

    vm.selectFork(optimismForkUrl);

    // origin
    // start with OP and swap to USDC to bridge to destination
    TransferHelper.safeApprove(OP_OP, address(swapAndXCall), 1000 ether);
    bytes
      memory oneInchApiDataOpToUsdc = hex"12aa3caf000000000000000000000000f0694acc9e941b176e17b9ef923e71e7b8b2477a00000000000000000000000042000000000000000000000000000000000000420000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c31607000000000000000000000000f0694acc9e941b176e17b9ef923e71e7b8b2477a0000000000000000000000007fa9385be102ac3eac297483dd6233d62b3e149600000000000000000000000000000000000000000000003635c9adc5dea0000000000000000000000000000000000000000000000000000000000000852b34070000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000059e00000000000000000000000000000000000000000000058000055200050800a0c9e75c48000000000000000009010000000000000000000000000000000000000000000000000004da00030d00a007e5c0d20000000000000000000000000000000000000000000000000002e90001505126a132dab612db5cb9fc9ac426a0cc215a3423f9c942000000000000000000000000000000000000420004f41766d8000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001aba068bc5bc09500000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000f0694acc9e941b176e17b9ef923e71e7b8b2477a000000000000000000000000000000000000000000000000000000006436bee0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000042000000000000000000000000000000000000420000000000000000000000004200000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000000a0c9e75c4800000000000000002d0500000000000000000000000000000000000000000000000000016b00011c4312f9d5940c2313636546ab9852354860dce275dbad000000000000000000000000000000000000000000000000000000000154cc12002424b31a0c000000000000000000000000f0694acc9e941b176e17b9ef923e71e7b8b2477a0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000001000276a400000000000000000000000000000000000000000000000000000000000000a00000000000000000000000000000000000000000000000000000000000000020000000000000000000000000420000000000000000000000000000000000000602a0000000000000000000000000000000000000000000000000000000000bfb1df4ee63c1e50185149247691df622eaf1a8bd0cafd40bc45154a9420000000000000000000000000000000000000600a0c9e75c480000000000000000270b00000000000000000000000000000000000000000000000000019f00004f02a0000000000000000000000000000000000000000000000000000000001a5e3475ee63c1e5011d751bc1a723accf1942122ca9aa82d49d08d2ae42000000000000000000000000000000000000425126a132dab612db5cb9fc9ac426a0cc215a3423f9c942000000000000000000000000000000000000420004f41766d80000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005d7d158a00000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000f0694acc9e941b176e17b9ef923e71e7b8b2477a000000000000000000000000000000000000000000000000000000006436bee0000000000000000000000000000000000000000000000000000000000000000100000000000000000000000042000000000000000000000000000000000000420000000000000000000000007f5c764cbc14f9669b88837ca1490cca17c31607000000000000000000000000000000000000000000000000000000000000000000a0f2fa6b667f5c764cbc14f9669b88837ca1490cca17c316070000000000000000000000000000000000000000000000000000000086838f0f0000000000000000000000000098a14880a06c4eca277f5c764cbc14f9669b88837ca1490cca17c316071111111254eeb25477b68fb85ed929f73a9605820000cfee7c08";

    // destination
    // set up destination swap params
    bytes
      memory oneInchApiDataUsdcToArb = hex"e449022e000000000000000000000000000000000000000000000000002386f26fc1000000000000000000000000000000000000000000000004aa05425d2de542d5e37c0000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000180000000000000000000000081c48d31365e6b526f6bbadc5c9aafd822134863cfee7c08";
    bytes memory _forwardCallData = abi.encode("Hello, Connext!");
    bytes memory _swapperData = abi.encode(
      address(oneInchUniswapV3),
      ARB_ARB,
      oneInchApiDataUsdcToArb,
      _forwardCallData
    );

    // final calldata includes both origin and destination swaps
    bytes memory callData = abi.encode(address(1), _swapperData);
    // set up swap calldata
    swapAndXCall.swapAndXCall(
      OP_OP,
      OP_USDC,
      1000 ether,
      ONEINCH_SWAPPER,
      oneInchApiDataOpToUsdc,
      ARBITRUM_DOMAIN_ID,
      address(greeter),
      address(this),
      300,
      callData,
      123 // fake relayer fee, will be in USDC
    );
  }
}
